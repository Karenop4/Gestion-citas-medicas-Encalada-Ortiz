<div class="appointment-management-container">
  <h2>Gestión de Citas Médicas</h2>

  <div class="filter-mode-buttons">
    <button [class.active]="filterMode === 'medico'" (click)="setFilterMode('medico')">
      Filtrar por Médico
    </button>
    <button [class.active]="filterMode === 'especialidad'" (click)="setFilterMode('especialidad')">
      Filtrar por Especialidad
    </button>
  </div>

  <div *ngIf="isLoading" class="loading-indicator">Cargando datos...</div>

  <div *ngIf="filterMode === 'medico'" class="filter-section">
    <h3>Seleccionar Médico</h3>
    <div class="select-container">
      <select [(ngModel)]="selectedDoctorId" (change)="onDoctorSelected()">
        <option [ngValue]="null" disabled>Selecciona un médico</option>
        <option *ngFor="let doctor of availableDoctors" [ngValue]="doctor.id">
          {{ doctor.nombre }}
        </option>
      </select>
    </div>

    <div *ngIf="selectedDoctorId" class="occupancy-bar-container">
      <div class="occupancy-bar" [ngClass]="occupancyBarColor">
        <p>{{ occupancyMessage }}</p>
      </div>
    </div>

    <div *ngIf="selectedDoctorId" class="data-section">
      <h4>Citas Pendientes de Dr. {{ selectedDoctorName }}</h4>
      <div *ngIf="pendingAppointments.length === 0 && !isLoading" class="no-data-message">
        No hay citas pendientes para este médico.
      </div>

      <div *ngIf="pendingAppointments.length > 0" class="table-container">
        <table>
          <thead>
            <tr>
              <th>ID Cita</th>
              <th>Paciente</th>
              <th>Fecha</th>
              <th>Hora</th>
              <th>Especialidad</th>
              <th>Estado</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let cita of pendingAppointments">
              <td>{{ cita.id }}</td>
              <td>{{ cita.paciente }}</td>
              <td>{{ cita.fecha | date:'fullDate' }}</td>
              <td>{{ cita.hora }}</td>
              <td>{{ cita.especialidad }}</td>
              <td>{{ cita.estado === 'p' ? 'Pendiente' : 'Confirmada' }}</td>
              <td>
                <button *ngIf="cita.estado === 'p'" class="confirm-button" (click)="openConfirmCancelModal('confirm', cita)">Confirmar</button>
                <button *ngIf="cita.estado === 'p'" class="cancel-button" (click)="openConfirmCancelModal('cancel', cita)">Cancelar</button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <button *ngIf="selectedDoctorId" class="download-button" (click)="downloadPdfReport()">
        Descargar Reporte PDF de Citas (Médico)
      </button>
    </div>
  </div>

  <div *ngIf="filterMode === 'especialidad'" class="filter-section">
    <h3>Seleccionar Especialidad</h3>
    <div class="select-container">
      <select [(ngModel)]="selectedSpecialtyId" (change)="onSpecialtySelected()">
        <option [ngValue]="null" disabled>Selecciona una especialidad</option>
        <option *ngFor="let specialty of availableSpecialties" [ngValue]="specialty.id">
          {{ specialty.nombre }}
        </option>
      </select>
    </div>

    <div *ngIf="selectedSpecialtyId" class="data-section">
      <h4>Citas Confirmadas de {{ selectedSpecialtyName }}</h4>
      <div *ngIf="confirmedAppointmentsBySpecialty.length === 0 && !isLoading" class="no-data-message">
        No hay citas confirmadas para esta especialidad.
      </div>

      <div *ngIf="confirmedAppointmentsBySpecialty.length > 0" class="table-container">
        <table>
          <thead>
            <tr>
              <th>ID Cita</th>
              <th>Paciente</th>
              <th>Médico</th>
              <th>Fecha</th>
              <th>Hora</th>
              <th>Estado</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let cita of confirmedAppointmentsBySpecialty">
              <td>{{ cita.id }}</td>
              <td>{{ cita.paciente }}</td>
              <td>{{ cita.medico }}</td>
              <td>{{ cita.fecha | date:'fullDate' }}</td>
              <td>{{ cita.hora }}</td>
              <td>{{ cita.estado === 'p' ? 'Pendiente' : 'Confirmada' }}</td>
            </tr>
          </tbody>
        </table>
      </div>

      <button *ngIf="selectedSpecialtyId" class="download-button" (click)="downloadPdfReportBySpecialty()">
        Descargar Reporte PDF de Citas (Especialidad)
      </button>
    </div>
  </div>
</div>

<div *ngIf="isModalOpen" class="modal-overlay">
  <div class="modal-content">
    <h3>{{ modalType === 'success' ? '¡Éxito!' : '¡Error!' }}</h3>
    <p>{{ modalMessage }}</p>
    <div class="modal-buttons">
      <button (click)="closeModal()" class="btn btn-secondary">Cerrar</button>
    </div>
  </div>
</div>

<div *ngIf="isConfirmCancelModalOpen" class="modal-overlay">
  <div class="modal-content">
    <h3>{{ confirmCancelModalAction === 'confirm' ? 'Confirmar Cita' : 'Cancelar Cita' }}</h3>
    <p>¿Estás seguro de que quieres {{ confirmCancelModalAction === 'confirm' ? 'confirmar' : 'cancelar' }} la cita para:</p>
    <p><strong>Paciente:</strong> {{ citaToConfirmCancel?.paciente }}</p>
    <p><strong>Fecha:</strong> {{ citaToConfirmCancel?.fecha | date:'fullDate' }}</p>
    <p><strong>Hora:</strong> {{ citaToConfirmCancel?.hora }}</p>
    <div class="modal-buttons">
      <button (click)="closeConfirmCancelModal()" class="btn btn-secondary">No</button>
      <button *ngIf="confirmCancelModalAction === 'confirm'" (click)="confirmAppointment()" class="btn btn-primary">Sí, Confirmar</button>
      <button *ngIf="confirmCancelModalAction === 'cancel'" (click)="cancelAppointment()" class="btn btn-danger">Sí, Cancelar</button>
    </div>
  </div>
</div>